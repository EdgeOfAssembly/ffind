<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ffind: ffind Architecture Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ffind
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_ARCHITECTURE.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ffind Architecture Documentation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md0"></a></p>
<p><b>Version:</b> 1.0 <br  />
 <b>Last Updated:</b> 2026-01-29 <br  />
 <b>Purpose:</b> Comprehensive architectural documentation for ffind daemon-based file finder</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md2"></a>
Table of Contents</h1>
<ol type="1">
<li>Overview</li>
<li>System Architecture</li>
<li>Component Descriptions</li>
<li>Data Flow Diagrams</li>
<li>Protocol Specification</li>
<li>Threading Model</li>
<li>Security Architecture</li>
<li>Storage and Persistence</li>
<li>Error Handling</li>
<li>Performance Optimizations</li>
</ol>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md4"></a>
Overview</h1>
<p>ffind is a high-performance file search system consisting of two main components:</p>
<ul>
<li><b>ffind-daemon</b> - Long-running server that maintains an in-memory file index</li>
<li><b>ffind</b> - Client CLI tool that queries the daemon and displays results</li>
</ul>
<p>The system uses Linux inotify for real-time filesystem monitoring and provides instant search capabilities through memory-resident indexes.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md6"></a>
System Architecture</h1>
<div class="fragment"><div class="line">┌─────────────────────────────────────────────────────────────────────┐</div>
<div class="line">│                          ffind System Architecture                   │</div>
<div class="line">└─────────────────────────────────────────────────────────────────────┘</div>
<div class="line"> </div>
<div class="line">                    ┌──────────────────────────────┐</div>
<div class="line">                    │      User Terminal           │</div>
<div class="line">                    │   $ ffind &quot;*.cpp&quot; -c &quot;TODO&quot;  │</div>
<div class="line">                    └──────────────┬───────────────┘</div>
<div class="line">                                   │</div>
<div class="line">                                   │ (executes)</div>
<div class="line">                                   │</div>
<div class="line">                    ┌──────────────▼───────────────┐</div>
<div class="line">                    │      ffind Client            │</div>
<div class="line">                    │   (ffind.cpp - ~400 LOC)     │</div>
<div class="line">                    │                              │</div>
<div class="line">                    │  • Parse CLI arguments       │</div>
<div class="line">                    │  • Serialize query           │</div>
<div class="line">                    │  • Connect to daemon socket  │</div>
<div class="line">                    │  • Stream and colorize output│</div>
<div class="line">                    └──────────────┬───────────────┘</div>
<div class="line">                                   │</div>
<div class="line">                                   │ Unix Domain Socket</div>
<div class="line">                                   │ /run/user/{UID}/ffind.sock</div>
<div class="line">                                   │</div>
<div class="line">                    ┌──────────────▼───────────────┐</div>
<div class="line">                    │    ffind-daemon              │</div>
<div class="line">                    │  (ffind-daemon.cpp ~2500 LOC)│</div>
<div class="line">                    │                              │</div>
<div class="line">                    │  ┌────────────────────────┐  │</div>
<div class="line">                    │  │  Main Event Loop       │  │</div>
<div class="line">                    │  │  • Accept connections  │  │</div>
<div class="line">                    │  │  • Monitor inotify     │  │</div>
<div class="line">                    │  │  • Handle queries      │  │</div>
<div class="line">                    │  └────────────────────────┘  │</div>
<div class="line">                    │                              │</div>
<div class="line">                    │  ┌────────────────────────┐  │</div>
<div class="line">                    │  │  In-Memory Index       │  │</div>
<div class="line">                    │  │  vector&lt;Entry&gt; entries │  │</div>
<div class="line">                    │  │  • File paths          │  │</div>
<div class="line">                    │  │  • Sizes, mtimes       │  │</div>
<div class="line">                    │  │  • Real-time updates   │  │</div>
<div class="line">                    │  └────────────────────────┘  │</div>
<div class="line">                    │                              │</div>
<div class="line">                    │  ┌────────────────────────┐  │</div>
<div class="line">                    │  │  Thread Pool           │  │</div>
<div class="line">                    │  │  • Parallel content    │  │</div>
<div class="line">                    │  │    search              │  │</div>
<div class="line">                    │  │  • N worker threads    │  │</div>
<div class="line">                    │  └────────────────────────┘  │</div>
<div class="line">                    │                              │</div>
<div class="line">                    │  ┌────────────────────────┐  │</div>
<div class="line">                    │  │  SQLite Persistence    │  │</div>
<div class="line">                    │  │  (Optional --db)       │  │</div>
<div class="line">                    │  │  • WAL mode            │  │</div>
<div class="line">                    │  │  • Periodic flushes    │  │</div>
<div class="line">                    │  └────────────────────────┘  │</div>
<div class="line">                    └───────┬──────────┬───────────┘</div>
<div class="line">                            │          │</div>
<div class="line">                    ┌───────▼──┐   ┌──▼────────┐</div>
<div class="line">                    │ inotify  │   │ Filesystem│</div>
<div class="line">                    │ Events   │   │ I/O       │</div>
<div class="line">                    └──────────┘   └───────────┘</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md8"></a>
Component Descriptions</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md9"></a>
ffind Client (ffind.cpp)</h2>
<p><b>Purpose:</b> Command-line interface for querying the daemon</p>
<p><b>Key Responsibilities:</b></p><ul>
<li>Parse command-line arguments and options</li>
<li>Validate input parameters</li>
<li>Serialize query into binary protocol</li>
<li>Connect to daemon via Unix socket</li>
<li>Stream results with color highlighting</li>
<li>Handle connection errors gracefully</li>
</ul>
<p><b>Key Functions:</b></p><ul>
<li><span class="tt"><a class="el" href="cache__flush_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main()</a></span> - <a class="el" href="structEntry.html">Entry</a> point, argument parsing, connection management</li>
<li>Output formatting with ANSI color codes</li>
<li>Regex/content match highlighting</li>
</ul>
<p><b>Dependencies:</b></p><ul>
<li>RE2 library (for regex support)</li>
<li>Unix socket API</li>
</ul>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md11"></a>
ffind-daemon (ffind-daemon.cpp)</h2>
<p><b>Purpose:</b> Long-running server maintaining file index</p>
<p><b>Key Responsibilities:</b></p><ul>
<li>Build and maintain in-memory file index</li>
<li>Monitor filesystem changes via inotify</li>
<li>Handle client queries efficiently</li>
<li>Persist index to SQLite (optional)</li>
<li>Manage thread pool for parallel searches</li>
</ul>
<p><b>Key Modules:</b></p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md12"></a>
1. Index Management</h3>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structEntry.html">Entry</a> {</div>
<div class="line">    <span class="keywordtype">string</span> <a class="code hl_variable" href="structEntry.html#ab9a48aa7387d27c826433ce35f6ba823">path</a>;           <span class="comment">// Full file path</span></div>
<div class="line">    uint64_t <a class="code hl_variable" href="structEntry.html#a45376b4fa084dbfcce738372fa018aa9">size</a>;         <span class="comment">// File size in bytes</span></div>
<div class="line">    time_t <a class="code hl_variable" href="structEntry.html#a7c953b65196958fa8e9530c2eaabd0ca">mtime</a>;          <span class="comment">// Modification time</span></div>
<div class="line">    <span class="keywordtype">bool</span> is_directory;     <span class="comment">// Directory flag</span></div>
<div class="line">};</div>
<div class="line">vector&lt;Entry&gt; <a class="code hl_variable" href="ffind-daemon_8cpp.html#a5527b3d38e1a219f363b1b9d0e80addf">entries</a>;     <span class="comment">// Main in-memory index</span></div>
<div class="ttc" id="affind-daemon_8cpp_html_a5527b3d38e1a219f363b1b9d0e80addf"><div class="ttname"><a href="ffind-daemon_8cpp.html#a5527b3d38e1a219f363b1b9d0e80addf">entries</a></div><div class="ttdeci">vector&lt; Entry &gt; entries</div><div class="ttdef"><b>Definition</b> ffind-daemon.cpp:296</div></div>
<div class="ttc" id="astructEntry_html"><div class="ttname"><a href="structEntry.html">Entry</a></div><div class="ttdef"><b>Definition</b> ffind-daemon.cpp:207</div></div>
<div class="ttc" id="astructEntry_html_a45376b4fa084dbfcce738372fa018aa9"><div class="ttname"><a href="structEntry.html#a45376b4fa084dbfcce738372fa018aa9">Entry::size</a></div><div class="ttdeci">int64_t size</div><div class="ttdef"><b>Definition</b> ffind-daemon.cpp:209</div></div>
<div class="ttc" id="astructEntry_html_a7c953b65196958fa8e9530c2eaabd0ca"><div class="ttname"><a href="structEntry.html#a7c953b65196958fa8e9530c2eaabd0ca">Entry::mtime</a></div><div class="ttdeci">time_t mtime</div><div class="ttdef"><b>Definition</b> ffind-daemon.cpp:210</div></div>
<div class="ttc" id="astructEntry_html_ab9a48aa7387d27c826433ce35f6ba823"><div class="ttname"><a href="structEntry.html#ab9a48aa7387d27c826433ce35f6ba823">Entry::path</a></div><div class="ttdeci">string path</div><div class="ttdef"><b>Definition</b> ffind-daemon.cpp:208</div></div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="autotoc_md13"></a>
2. inotify Integration</h3>
<ul>
<li>Watches all directories recursively</li>
<li>Handles CREATE, DELETE, MODIFY, MOVE events</li>
<li>Cookie-based rename tracking</li>
<li>Automatic watch descriptor management</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md14"></a>
3. Query Handler</h3>
<ul>
<li>Deserializes client requests</li>
<li>Filters entries by multiple criteria</li>
<li>Executes parallel content searches</li>
<li>Batches results for efficient transmission</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md15"></a>
4. Thread Pool</h3>
<ul>
<li>Pre-allocated worker threads</li>
<li>Task queue for content search jobs</li>
<li>Synchronization via mutex and condition variables</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md16"></a>
5. SQLite Persistence</h3>
<ul>
<li>WAL mode for concurrent access</li>
<li>Periodic flushes (every 30s or 100 changes)</li>
<li>Reconciliation on startup</li>
<li>Atomic transactions</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md18"></a>
Data Flow Diagrams</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md19"></a>
Query Processing Flow</h2>
<div class="fragment"><div class="line">┌──────────┐</div>
<div class="line">│  Client  │</div>
<div class="line">│ (ffind)  │</div>
<div class="line">└────┬─────┘</div>
<div class="line">     │</div>
<div class="line">     │ 1. Serialize Query</div>
<div class="line">     │    ┌────────────────────────────────────┐</div>
<div class="line">     │    │ Binary Protocol (Network Byte Order)│</div>
<div class="line">     │    │ • name_pattern_len (4 bytes)       │</div>
<div class="line">     │    │ • name_pattern (UTF-8)             │</div>
<div class="line">     │    │ • path_pattern_len (4 bytes)       │</div>
<div class="line">     │    │ • path_pattern (UTF-8)             │</div>
<div class="line">     │    │ • content_pattern_len (4 bytes)    │</div>
<div class="line">     │    │ • content_pattern (UTF-8)          │</div>
<div class="line">     │    │ • flags (1 byte)                   │</div>
<div class="line">     │    │   - case_insensitive: bit 0        │</div>
<div class="line">     │    │   - use_regex: bit 1               │</div>
<div class="line">     │    │   - use_glob: bit 2                │</div>
<div class="line">     │    │ • type_filter (1 byte)             │</div>
<div class="line">     │    │ • size_op, size_val (9 bytes)      │</div>
<div class="line">     │    │ • mtime_op, mtime_days (5 bytes)   │</div>
<div class="line">     │    │ • before_ctx, after_ctx (2 bytes)  │</div>
<div class="line">     │    └────────────────────────────────────┘</div>
<div class="line">     │</div>
<div class="line">     │ 2. Send to Daemon</div>
<div class="line">     ▼</div>
<div class="line">┌─────────────────┐</div>
<div class="line">│   Unix Socket   │</div>
<div class="line">│ /run/user/{UID}/│</div>
<div class="line">│  ffind.sock     │</div>
<div class="line">└────┬────────────┘</div>
<div class="line">     │</div>
<div class="line">     │ 3. Daemon Receives</div>
<div class="line">     ▼</div>
<div class="line">┌────────────────────────────────────────────────┐</div>
<div class="line">│              ffind-daemon                      │</div>
<div class="line">│                                                │</div>
<div class="line">│  ┌──────────────────────────────────────────┐ │</div>
<div class="line">│  │ handle_client()                          │ │</div>
<div class="line">│  │                                          │ │</div>
<div class="line">│  │  Step 1: Deserialize query               │ │</div>
<div class="line">│  │  ├─ Validate string lengths (&lt;1MB)       │ │</div>
<div class="line">│  │  └─ Parse all filter parameters          │ │</div>
<div class="line">│  │                                          │ │</div>
<div class="line">│  │  Step 2: Lock mutex, access entries[]    │ │</div>
<div class="line">│  │                                          │ │</div>
<div class="line">│  │  Step 3: Filter Phase 1 (Metadata)       │ │</div>
<div class="line">│  │  ├─ Name pattern (glob/regex)            │ │</div>
<div class="line">│  │  ├─ Path pattern (glob/regex)            │ │</div>
<div class="line">│  │  ├─ Type filter (file/dir)               │ │</div>
<div class="line">│  │  ├─ Size filter (+/-/=)                  │ │</div>
<div class="line">│  │  └─ Mtime filter (+/-/=)                 │ │</div>
<div class="line">│  │       ↓                                  │ │</div>
<div class="line">│  │   candidates[] vector                    │ │</div>
<div class="line">│  │                                          │ │</div>
<div class="line">│  │  Step 4: Content Search (if needed)      │ │</div>
<div class="line">│  │  ├─ Dispatch to thread pool              │ │</div>
<div class="line">│  │  ├─ Each thread:                         │ │</div>
<div class="line">│  │  │   • mmap file (MAP_PRIVATE)           │ │</div>
<div class="line">│  │  │   • Scan lines                        │ │</div>
<div class="line">│  │  │   • Match pattern (fixed/regex/glob)  │ │</div>
<div class="line">│  │  │   • Collect context lines             │ │</div>
<div class="line">│  │  └─ Aggregate results                    │ │</div>
<div class="line">│  │                                          │ │</div>
<div class="line">│  │  Step 5: Send Results                    │ │</div>
<div class="line">│  │  └─ Batch with writev() for efficiency   │ │</div>
<div class="line">│  └──────────────────────────────────────────┘ │</div>
<div class="line">└────────────────────────────────────────────────┘</div>
<div class="line">     │</div>
<div class="line">     │ 4. Stream Results</div>
<div class="line">     ▼</div>
<div class="line">┌──────────┐</div>
<div class="line">│  Client  │</div>
<div class="line">│  ├─ Read line by line                       │</div>
<div class="line">│  ├─ Apply color highlighting                │</div>
<div class="line">│  └─ Output to stdout                        │</div>
<div class="line">└──────────┘</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md20"></a>
Filesystem Change Propagation</h2>
<div class="fragment"><div class="line">┌───────────────┐</div>
<div class="line">│  Filesystem   │</div>
<div class="line">│   Changes     │</div>
<div class="line">│               │</div>
<div class="line">│  • create()   │</div>
<div class="line">│  • unlink()   │</div>
<div class="line">│  • rename()   │</div>
<div class="line">│  • write()    │</div>
<div class="line">└───────┬───────┘</div>
<div class="line">        │</div>
<div class="line">        │ Kernel generates events</div>
<div class="line">        ▼</div>
<div class="line">┌─────────────────────────────────────┐</div>
<div class="line">│      Linux inotify Subsystem        │</div>
<div class="line">│                                     │</div>
<div class="line">│  Event Types:                       │</div>
<div class="line">│  • IN_CREATE                        │</div>
<div class="line">│  • IN_DELETE                        │</div>
<div class="line">│  • IN_MODIFY                        │</div>
<div class="line">│  • IN_MOVED_FROM / IN_MOVED_TO      │</div>
<div class="line">│  • IN_DELETE_SELF                   │</div>
<div class="line">└───────┬─────────────────────────────┘</div>
<div class="line">        │</div>
<div class="line">        │ Events queued in kernel buffer</div>
<div class="line">        │ Read via read() on inotify fd</div>
<div class="line">        ▼</div>
<div class="line">┌──────────────────────────────────────────┐</div>
<div class="line">│        ffind-daemon Event Loop           │</div>
<div class="line">│                                          │</div>
<div class="line">│  ┌────────────────────────────────────┐  │</div>
<div class="line">│  │ process_events()                   │  │</div>
<div class="line">│  │                                    │  │</div>
<div class="line">│  │  while (true) {                    │  │</div>
<div class="line">│  │    poll(inotify_fd, timeout)       │  │</div>
<div class="line">│  │    if (events_ready) {             │  │</div>
<div class="line">│  │      read(inotify_fd, buf, size)   │  │</div>
<div class="line">│  │      for each event:               │  │</div>
<div class="line">│  │        switch (event.mask) {       │  │</div>
<div class="line">│  │          case IN_CREATE:           │  │</div>
<div class="line">│  │            add_entry()             │  │</div>
<div class="line">│  │          case IN_DELETE:           │  │</div>
<div class="line">│  │            remove_entry()          │  │</div>
<div class="line">│  │          case IN_MODIFY:           │  │</div>
<div class="line">│  │            update_mtime()          │  │</div>
<div class="line">│  │          case IN_MOVED_FROM:       │  │</div>
<div class="line">│  │            store_cookie()          │  │</div>
<div class="line">│  │          case IN_MOVED_TO:         │  │</div>
<div class="line">│  │            handle_rename()         │  │</div>
<div class="line">│  │        }                           │  │</div>
<div class="line">│  │    }                               │  │</div>
<div class="line">│  │  }                                 │  │</div>
<div class="line">│  └────────────────────────────────────┘  │</div>
<div class="line">│                                          │</div>
<div class="line">│  Index Updates:                          │</div>
<div class="line">│  ┌────────────────────────────────────┐  │</div>
<div class="line">│  │ Lock entries_mutex                 │  │</div>
<div class="line">│  │ Modify entries[] vector            │  │</div>
<div class="line">│  │ Update pending_changes counter     │  │</div>
<div class="line">│  │ Unlock entries_mutex               │  │</div>
<div class="line">│  └────────────────────────────────────┘  │</div>
<div class="line">│                                          │</div>
<div class="line">│  Periodic DB Flush:                      │</div>
<div class="line">│  ┌────────────────────────────────────┐  │</div>
<div class="line">│  │ if (pending &gt;= 100 || 30s elapsed) │  │</div>
<div class="line">│  │   flush_changes_to_db()            │  │</div>
<div class="line">│  └────────────────────────────────────┘  │</div>
<div class="line">└──────────────────────────────────────────┘</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md22"></a>
Protocol Specification</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md23"></a>
Client-to-Daemon Binary Protocol</h2>
<p>All multi-byte integers use <b>network byte order</b> (big-endian).</p>
<div class="fragment"><div class="line">┌─────────────────────────────────────────────────────────────┐</div>
<div class="line">│                    Query Request Format                      │</div>
<div class="line">├─────────────────────────────────────────────────────────────┤</div>
<div class="line">│ Offset │ Length │ Type    │ Field             │ Notes        │</div>
<div class="line">├────────┼────────┼─────────┼───────────────────┼──────────────┤</div>
<div class="line">│   0    │   4    │ uint32  │ name_pattern_len  │ Network order│</div>
<div class="line">│   4    │   N    │ char[]  │ name_pattern      │ UTF-8        │</div>
<div class="line">│  4+N   │   4    │ uint32  │ path_pattern_len  │ Network order│</div>
<div class="line">│  8+N   │   M    │ char[]  │ path_pattern      │ UTF-8        │</div>
<div class="line">│ 8+N+M  │   4    │ uint32  │ content_pat_len   │ Network order│</div>
<div class="line">│12+N+M  │   K    │ char[]  │ content_pattern   │ UTF-8        │</div>
<div class="line">│12+N+M+K│   1    │ uint8   │ flags             │ See below    │</div>
<div class="line">│13+N+M+K│   1    │ uint8   │ type_filter       │ 0=all,1=f,2=d│</div>
<div class="line">│14+N+M+K│   1    │ uint8   │ size_op           │ 0=none,1=+,-,=│</div>
<div class="line">│15+N+M+K│   8    │ uint64  │ size_val          │ Only if op≠0 │</div>
<div class="line">│23+N+M+K│   1    │ uint8   │ mtime_op          │ 0=none,1=+,-,=│</div>
<div class="line">│24+N+M+K│   4    │ int32   │ mtime_days        │ Only if op≠0 │</div>
<div class="line">│28+N+M+K│   1    │ uint8   │ before_ctx        │ Lines before │</div>
<div class="line">│29+N+M+K│   1    │ uint8   │ after_ctx         │ Lines after  │</div>
<div class="line">└─────────────────────────────────────────────────────────────┘</div>
<div class="line"> </div>
<div class="line">Flags byte (bit fields):</div>
<div class="line">┌───┬───┬───┬───┬───┬───┬───┬───┐</div>
<div class="line">│ 7 │ 6 │ 5 │ 4 │ 3 │ 2 │ 1 │ 0 │</div>
<div class="line">├───┼───┼───┼───┼───┼───┼───┼───┤</div>
<div class="line">│   │   │   │   │   │ G │ R │ I │</div>
<div class="line">└───┴───┴───┴───┴───┴───┴───┴───┘</div>
<div class="line">  I = case_insensitive (bit 0)</div>
<div class="line">  R = use_regex (bit 1)</div>
<div class="line">  G = use_glob (bit 2)</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md24"></a>
Daemon-to-Client Response Format</h2>
<p>Results are streamed as newline-delimited text:</p>
<div class="fragment"><div class="line">For metadata-only searches:</div>
<div class="line">    /path/to/file1\n</div>
<div class="line">    /path/to/file2\n</div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">For content searches (no context):</div>
<div class="line">    /path/to/file:123:matched line content\n</div>
<div class="line">    /path/to/file:456:another match\n</div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">For content searches (with context):</div>
<div class="line">    /path/to/file:120-context line before\n</div>
<div class="line">    /path/to/file:121-another context\n</div>
<div class="line">    /path/to/file:122:MATCHED LINE\n</div>
<div class="line">    /path/to/file:123-context after\n</div>
<div class="line">    --\n</div>
<div class="line">    /path/to/file:200:ANOTHER MATCH\n</div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">Format:</div>
<div class="line">    {path}:{line_number}{separator}{line_content}\n</div>
<div class="line">    </div>
<div class="line">    Separator:</div>
<div class="line">      &#39;:&#39; = matching line</div>
<div class="line">      &#39;-&#39; = context line</div>
<div class="line">    </div>
<div class="line">    Group separator: &#39;--\n&#39; between non-contiguous groups</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md26"></a>
Threading Model</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md27"></a>
Overview</h2>
<p>ffind-daemon uses a <b>hybrid threading model</b>:</p>
<ol type="1">
<li><b>Main thread</b> - Event loop for inotify and socket accept</li>
<li><b>Client handler threads</b> - One per active client connection (short-lived)</li>
<li><b>Worker thread pool</b> - Pre-allocated threads for content search</li>
</ol>
<div class="fragment"><div class="line">┌────────────────────────────────────────────────────────────┐</div>
<div class="line">│                  ffind-daemon Threading                     │</div>
<div class="line">└────────────────────────────────────────────────────────────┘</div>
<div class="line"> </div>
<div class="line">Main Thread (Event Loop)</div>
<div class="line">━━━━━━━━━━━━━━━━━━━━━━</div>
<div class="line">  │</div>
<div class="line">  ├──→ poll() on:</div>
<div class="line">  │    ├─ inotify_fd      (filesystem events)</div>
<div class="line">  │    └─ listen_sock_fd  (new client connections)</div>
<div class="line">  │</div>
<div class="line">  ├──→ inotify events → process_events()</div>
<div class="line">  │    └─ Update entries[] vector (mutex protected)</div>
<div class="line">  │</div>
<div class="line">  └──→ accept() → spawn thread → handle_client()</div>
<div class="line">                                      ↓</div>
<div class="line">                        ┌─────────────────────────┐</div>
<div class="line">                        │  Client Handler Thread  │</div>
<div class="line">                        │  (short-lived)          │</div>
<div class="line">                        │                         │</div>
<div class="line">                        │  1. Deserialize query   │</div>
<div class="line">                        │  2. Lock entries_mutex  │</div>
<div class="line">                        │  3. Filter metadata     │</div>
<div class="line">                        │  4. If content search:  │</div>
<div class="line">                        │     dispatch to pool    │</div>
<div class="line">                        │  5. Send results        │</div>
<div class="line">                        │  6. Close socket        │</div>
<div class="line">                        │  7. Thread exits        │</div>
<div class="line">                        └────────┬────────────────┘</div>
<div class="line">                                 │</div>
<div class="line">                                 │ Content search dispatch</div>
<div class="line">                                 ▼</div>
<div class="line">        ┌───────────────────────────────────────────────┐</div>
<div class="line">        │           Worker Thread Pool                  │</div>
<div class="line">        │                                               │</div>
<div class="line">        │  ┌──────────┐  ┌──────────┐  ┌──────────┐   │</div>
<div class="line">        │  │ Worker 1 │  │ Worker 2 │  │ Worker N │   │</div>
<div class="line">        │  └─────┬────┘  └─────┬────┘  └─────┬────┘   │</div>
<div class="line">        │        │             │             │         │</div>
<div class="line">        │        └─────────────┴─────────────┘         │</div>
<div class="line">        │                     │                        │</div>
<div class="line">        │            Task Queue (mutex + CV)           │</div>
<div class="line">        │         ┌──────────────────────┐             │</div>
<div class="line">        │         │ Task: search file X  │             │</div>
<div class="line">        │         │ Task: search file Y  │             │</div>
<div class="line">        │         │ Task: search file Z  │             │</div>
<div class="line">        │         └──────────────────────┘             │</div>
<div class="line">        │                                               │</div>
<div class="line">        │  Each worker:                                 │</div>
<div class="line">        │    while (true) {                             │</div>
<div class="line">        │      wait_for_task()                          │</div>
<div class="line">        │      task = dequeue()                         │</div>
<div class="line">        │      result = search_file(task)               │</div>
<div class="line">        │      store_result(result)                     │</div>
<div class="line">        │    }                                          │</div>
<div class="line">        └───────────────────────────────────────────────┘</div>
<div class="line"> </div>
<div class="line">Synchronization:</div>
<div class="line">  • entries_mutex: Protects entries[] vector</div>
<div class="line">  • queue_mutex + queue_cv: Thread pool task queue</div>
<div class="line">  • results_mutex: Protects content search results</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md28"></a>
Thread Safety Guarantees</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Resource  </th><th class="markdownTableHeadNone">Protection Mechanism  </th><th class="markdownTableHeadNone">Access Pattern  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt"><a class="el" href="ffind-daemon_8cpp.html#a5527b3d38e1a219f363b1b9d0e80addf">entries</a>[]</span>  </td><td class="markdownTableBodyNone"><span class="tt">entries_mutex</span>  </td><td class="markdownTableBodyNone">Read: many, Write: exclusive  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><span class="tt"><a class="el" href="ffind-daemon_8cpp.html#a67eae545b818fdaaefbdd25be353882a">path_index</a></span>  </td><td class="markdownTableBodyNone"><span class="tt">entries_mutex</span>  </td><td class="markdownTableBodyNone">Rebuilt when entries modified  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Task queue  </td><td class="markdownTableBodyNone"><span class="tt">queue_mutex + queue_cv</span>  </td><td class="markdownTableBodyNone">Producer-consumer  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Content results  </td><td class="markdownTableBodyNone"><span class="tt">results_mutex</span>  </td><td class="markdownTableBodyNone">Append-only during search  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SQLite database  </td><td class="markdownTableBodyNone">SQLite internal locking  </td><td class="markdownTableBodyNone">WAL mode for concurrency  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">inotify watches  </td><td class="markdownTableBodyNone">Single-threaded access  </td><td class="markdownTableBodyNone">Main thread only  </td></tr>
</table>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md30"></a>
Security Architecture</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md31"></a>
Threat Model</h2>
<p><b>Assumptions:</b></p><ul>
<li>Daemon runs as unprivileged user</li>
<li>Unix socket is per-user (untrusted users cannot connect)</li>
<li>Filesystem is trusted (daemon watches paths it has permission to read)</li>
<li>Network is local only (Unix domain sockets)</li>
</ul>
<p><b>Attack Vectors Considered:</b></p><ol type="1">
<li>Malicious client sending crafted queries</li>
<li>Resource exhaustion (CPU, memory, file descriptors)</li>
<li>Path traversal attempts</li>
<li>Signal-based attacks during critical sections</li>
<li>Race conditions in filesystem operations</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md32"></a>
Security Layers</h2>
<div class="fragment"><div class="line">┌──────────────────────────────────────────────────────────┐</div>
<div class="line">│              Defense-in-Depth Layers                      │</div>
<div class="line">└──────────────────────────────────────────────────────────┘</div>
<div class="line"> </div>
<div class="line">Layer 1: Network Input Validation</div>
<div class="line">═══════════════════════════════════</div>
<div class="line">  ✓ String length limits (1MB max per field)</div>
<div class="line">  ✓ Integer overflow checks</div>
<div class="line">  ✓ Safe deserialization with bounds checking</div>
<div class="line">  ✓ Reject malformed protocol messages</div>
<div class="line"> </div>
<div class="line">      ↓ Query accepted</div>
<div class="line">      </div>
<div class="line">Layer 2: Filesystem Access Control</div>
<div class="line">══════════════════════════════════</div>
<div class="line">  ✓ Symlink detection and skipping (prevent loops)</div>
<div class="line">  ✓ Permission checks (open() will fail if not readable)</div>
<div class="line">  ✓ Path canonicalization (prevent ../ attacks)</div>
<div class="line">  ✓ Per-user socket isolation</div>
<div class="line"> </div>
<div class="line">      ↓ Paths validated</div>
<div class="line">      </div>
<div class="line">Layer 3: Resource Limits</div>
<div class="line">═══════════════════════</div>
<div class="line">  ✓ Thread pool size bounded (prevent fork bombs)</div>
<div class="line">  ✓ File size checks before mmap</div>
<div class="line">  ✓ Binary file detection (skip non-text)</div>
<div class="line">  ✓ Socket timeout and cleanup</div>
<div class="line"> </div>
<div class="line">      ↓ Resources allocated safely</div>
<div class="line">      </div>
<div class="line">Layer 4: Memory Safety</div>
<div class="line">═════════════════════</div>
<div class="line">  ✓ Modern C++ (smart pointers, RAII)</div>
<div class="line">  ✓ Vector bounds checking (at() for critical access)</div>
<div class="line">  ✓ MAP_PRIVATE for mmap (no accidental writes)</div>
<div class="line">  ✓ No buffer overflows (std::string, std::vector)</div>
<div class="line"> </div>
<div class="line">      ↓ Memory operations safe</div>
<div class="line">      </div>
<div class="line">Layer 5: Error Handling</div>
<div class="line">══════════════════════</div>
<div class="line">  ✓ All syscalls checked for errors</div>
<div class="line">  ✓ EINTR handling for all I/O</div>
<div class="line">  ✓ EPIPE handling for broken connections</div>
<div class="line">  ✓ Graceful degradation on failures</div>
<div class="line"> </div>
<div class="line">      ↓ Errors handled properly</div>
<div class="line">      </div>
<div class="line">Layer 6: Signal Safety</div>
<div class="line">═════════════════════</div>
<div class="line">  ✓ Only async-signal-safe functions in handlers</div>
<div class="line">  ✓ Atomic flag for shutdown coordination</div>
<div class="line">  ✓ No malloc/free in signal context</div>
<div class="line">  ✓ Minimal work in handlers</div>
<div class="line"> </div>
<div class="line">      ↓ Signal-safe operation</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md33"></a>
Security-Critical Code Sections</h2>
<p><b>SECURITY markers in code identify critical sections:</b></p>
<ol type="1">
<li><b>Network deserialization</b> (<span class="tt"><a class="el" href="ffind-daemon_8cpp.html#aa29c4f34a63bacc7d3bcd55e101133fd">handle_client()</a></span> lines 1692-1733)<ul>
<li>Validates all input lengths before allocation</li>
<li>Rejects oversized requests</li>
</ul>
</li>
<li><b>Signal handlers</b> (<span class="tt"><a class="el" href="ffind-daemon_8cpp.html#a5054c36923934387c6f7605dd1a2f3c9">sig_handler()</a></span>, <span class="tt"><a class="el" href="ffind-daemon_8cpp.html#ae7ca651aefd5176935c0a94a0389e957">crash_handler()</a></span>)<ul>
<li>Uses only write() with fixed buffers</li>
<li>No heap allocation or C++ streams</li>
</ul>
</li>
<li><b>Filesystem traversal</b> (<span class="tt"><a class="el" href="ffind-daemon_8cpp.html#a3c6ea839f8269e1c879bece01b9d43a0">add_directory_recursive()</a></span>)<ul>
<li>Checks <span class="tt">is_symlink()</span> to prevent loops</li>
<li>Skips entries that fail permission checks</li>
</ul>
</li>
<li><b>Memory mapping</b> (<span class="tt"><a class="el" href="structMappedFile.html">MappedFile</a></span> class)<ul>
<li>Uses MAP_PRIVATE (read-only semantics)</li>
<li>Checks file size before mapping</li>
<li>Handles mmap failures gracefully</li>
</ul>
</li>
<li><b>Database operations</b> (various <span class="tt">*_db()</span> functions)<ul>
<li>Parameterized queries (no SQL injection)</li>
<li>Transaction boundaries for atomicity</li>
<li>Proper error handling for corruption</li>
</ul>
</li>
</ol>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md35"></a>
Storage and Persistence</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md36"></a>
In-Memory Index Structure</h2>
<div class="fragment"><div class="line">┌──────────────────────────────────────────────────┐</div>
<div class="line">│           Primary Index: vector&lt;Entry&gt;           │</div>
<div class="line">├──────────────────────────────────────────────────┤</div>
<div class="line">│                                                  │</div>
<div class="line">│  Entry 0: {path=&quot;/home/user/doc.txt&quot;,           │</div>
<div class="line">│            size=4096, mtime=1706572800,          │</div>
<div class="line">│            is_directory=false}                   │</div>
<div class="line">│                                                  │</div>
<div class="line">│  Entry 1: {path=&quot;/home/user/code/&quot;,             │</div>
<div class="line">│            size=0, mtime=1706572900,             │</div>
<div class="line">│            is_directory=true}                    │</div>
<div class="line">│                                                  │</div>
<div class="line">│  Entry 2: {path=&quot;/home/user/code/main.cpp&quot;,     │</div>
<div class="line">│            size=2048, mtime=1706573000,          │</div>
<div class="line">│            is_directory=false}                   │</div>
<div class="line">│            ...                                   │</div>
<div class="line">│            (sorted by path for binary search)    │</div>
<div class="line">└──────────────────────────────────────────────────┘</div>
<div class="line">                      │</div>
<div class="line">                      │ Supplemented by</div>
<div class="line">                      ▼</div>
<div class="line">┌──────────────────────────────────────────────────┐</div>
<div class="line">│        PathIndex: map&lt;string, vector&lt;size_t&gt;&gt;    │</div>
<div class="line">├──────────────────────────────────────────────────┤</div>
<div class="line">│                                                  │</div>
<div class="line">│  &quot;home&quot; → [1]                                    │</div>
<div class="line">│  &quot;home/user&quot; → [1]                               │</div>
<div class="line">│  &quot;home/user/code&quot; → [1, 2]                       │</div>
<div class="line">│                                                  │</div>
<div class="line">│  (Maps directory paths to entry indices for     │</div>
<div class="line">│   fast path-based queries like -path &quot;code/*&quot;)  │</div>
<div class="line">└──────────────────────────────────────────────────┘</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md37"></a>
SQLite Schema (Optional Persistence)</h2>
<div class="fragment"><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> entries (</div>
<div class="line">    path TEXT <span class="keyword">PRIMARY</span> KEY,</div>
<div class="line">    size <span class="keywordtype">INTEGER</span> <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">    mtime <span class="keywordtype">INTEGER</span> <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>,</div>
<div class="line">    is_directory <span class="keywordtype">INTEGER</span> <span class="keyword">NOT</span> <span class="stringliteral">NULL</span>  <span class="comment">-- 0 or 1</span></div>
<div class="line">);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">CREATE</span> INDEX idx_mtime <span class="keyword">ON</span> entries(mtime);</div>
<div class="line"><span class="keyword">CREATE</span> INDEX idx_size <span class="keyword">ON</span> entries(size);</div>
<div class="line"> </div>
<div class="line"><span class="comment">-- Metadata table for reconciliation</span></div>
<div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> metadata (</div>
<div class="line">    key TEXT <span class="keyword">PRIMARY</span> KEY,</div>
<div class="line">    <span class="keyword">value</span> TEXT</div>
<div class="line">);</div>
<div class="line"><span class="comment">-- Stores: last_sync_time, root_paths, version</span></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md38"></a>
Persistence Flow</h2>
<div class="fragment"><div class="line">┌───────────────────────────────────────────────────────┐</div>
<div class="line">│              Persistence Lifecycle                     │</div>
<div class="line">└───────────────────────────────────────────────────────┘</div>
<div class="line"> </div>
<div class="line">Daemon Startup with --db:</div>
<div class="line">═════════════════════════</div>
<div class="line">  1. Open/create SQLite database</div>
<div class="line">  2. Enable WAL mode (sqlite3_exec(&quot;PRAGMA journal_mode=WAL&quot;))</div>
<div class="line">  3. Load entries from database → entries[] vector</div>
<div class="line">  4. Perform filesystem reconciliation:</div>
<div class="line">     ├─ Scan filesystem for actual files</div>
<div class="line">     ├─ Compare with DB entries</div>
<div class="line">     ├─ Add new files</div>
<div class="line">     ├─ Remove deleted files</div>
<div class="line">     └─ Update changed files</div>
<div class="line">  5. Mark database as synced</div>
<div class="line"> </div>
<div class="line">Runtime Operation:</div>
<div class="line">═════════════════</div>
<div class="line">  Main Loop:</div>
<div class="line">    ├─ Process inotify events</div>
<div class="line">    ├─ Update entries[] in memory</div>
<div class="line">    ├─ Increment pending_changes counter</div>
<div class="line">    │</div>
<div class="line">    └─ Periodic check (every iteration):</div>
<div class="line">        if (pending_changes &gt;= 100 || time_since_flush &gt; 30s) {</div>
<div class="line">          flush_changes_to_db()</div>
<div class="line">          pending_changes = 0</div>
<div class="line">          last_flush_time = now</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">Graceful Shutdown:</div>
<div class="line">═════════════════</div>
<div class="line">  1. Receive SIGTERM/SIGINT</div>
<div class="line">  2. Set shutdown flag</div>
<div class="line">  3. Flush remaining changes to DB</div>
<div class="line">  4. Close database connection</div>
<div class="line">  5. Unlink socket file</div>
<div class="line">  6. Exit</div>
<div class="line"> </div>
<div class="line">Crash Recovery:</div>
<div class="line">══════════════</div>
<div class="line">  • WAL mode ensures atomic commits</div>
<div class="line">  • On next startup, reconcile detects inconsistencies</div>
<div class="line">  • Missing entries are re-indexed from filesystem</div>
<div class="line">  • Database integrity maintained</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md40"></a>
Error Handling</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md41"></a>
Error Handling Strategy</h2>
<p>ffind follows a <b>graceful degradation</b> approach:</p>
<ol type="1">
<li><b>Non-fatal errors</b>: Log and continue (e.g., permission denied on one file)</li>
<li><b>Connection errors</b>: Close client socket, continue serving others</li>
<li><b>Fatal errors</b>: Flush database, cleanup, exit with error code</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md42"></a>
Error Categories and Responses</h2>
<div class="fragment"><div class="line">┌──────────────────────────────────────────────────────────┐</div>
<div class="line">│                 Error Handling Matrix                     │</div>
<div class="line">├─────────────────┬────────────────────┬───────────────────┤</div>
<div class="line">│ Error Type      │ Example            │ Response          │</div>
<div class="line">├─────────────────┼────────────────────┼───────────────────┤</div>
<div class="line">│ I/O Error       │ EINTR on read()    │ Retry syscall     │</div>
<div class="line">│                 │ EAGAIN on write()  │ Retry with poll() │</div>
<div class="line">│                 │ EPIPE on write()   │ Close connection  │</div>
<div class="line">│                 │ EIO on disk        │ Skip file, log    │</div>
<div class="line">├─────────────────┼────────────────────┼───────────────────┤</div>
<div class="line">│ Permission      │ EACCES on open()   │ Skip file, warn   │</div>
<div class="line">│                 │ EPERM on inotify   │ Skip dir, warn    │</div>
<div class="line">├─────────────────┼────────────────────┼───────────────────┤</div>
<div class="line">│ Resource Limit  │ ENFILE (too many   │ Wait and retry    │</div>
<div class="line">│                 │  open files)       │ or fail gracefully│</div>
<div class="line">│                 │ EMFILE             │                   │</div>
<div class="line">├─────────────────┼────────────────────┼───────────────────┤</div>
<div class="line">│ Protocol Error  │ Invalid query      │ Send error msg,   │</div>
<div class="line">│                 │ Oversized input    │ close connection  │</div>
<div class="line">├─────────────────┼────────────────────┼───────────────────┤</div>
<div class="line">│ Database Error  │ SQLITE_BUSY        │ Retry with backoff│</div>
<div class="line">│                 │ SQLITE_CORRUPT     │ Warn, disable DB  │</div>
<div class="line">├─────────────────┼────────────────────┼───────────────────┤</div>
<div class="line">│ Signal          │ SIGTERM            │ Graceful shutdown │</div>
<div class="line">│                 │ SIGSEGV            │ Flush DB, dump    │</div>
<div class="line">│                 │                    │ stack, exit       │</div>
<div class="line">└─────────────────┴────────────────────┴───────────────────┘</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md43"></a>
Error Logging</h2>
<p><b>Foreground mode:</b> Detailed logging to stderr with color codes <b>Background mode:</b> Minimal logging (errors only)</p>
<p>Log levels:</p><ul>
<li><span class="tt">[INFO]</span> - Normal operation (foreground only)</li>
<li><span class="tt">[WARNING]</span> - Non-fatal issues (yellow)</li>
<li><span class="tt">[ERROR]</span> - Fatal errors (red)</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md45"></a>
Performance Optimizations</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md46"></a>
1. Memory-Resident Index</h2>
<p><b>Optimization:</b> Keep entire file index in RAM</p>
<p><b>Benefit:</b></p><ul>
<li>Metadata queries complete in microseconds</li>
<li>No disk I/O for name/path/size/mtime filters</li>
<li>Binary search on sorted vector (O(log n))</li>
</ul>
<p><b>Trade-off:</b> Memory usage ~100 bytes per file</p>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md48"></a>
2. Thread Pool for Content Search</h2>
<p><b>Optimization:</b> Pre-allocated worker threads</p>
<p><b>Benefit:</b></p><ul>
<li>No thread creation overhead per query</li>
<li>Parallel file scanning (utilizes all CPU cores)</li>
<li>Task queue for load balancing</li>
</ul>
<p><b>Implementation:</b> </p><div class="fragment"><div class="line">Thread pool size = min(32, hardware_concurrency())</div>
<div class="line">Each worker processes subset of candidate files</div>
<div class="line">Results aggregated before transmission</div>
</div><!-- fragment --><hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md50"></a>
3. Batched Result Transmission</h2>
<p><b>Optimization:</b> Use <span class="tt">writev()</span> to batch multiple results</p>
<p><b>Benefit:</b></p><ul>
<li>Fewer system calls (10-100x reduction)</li>
<li>Better throughput for large result sets</li>
<li>Reduced per-call overhead</li>
</ul>
<p><b>Implementation:</b> </p><div class="fragment"><div class="line">vector&lt;iovec&gt; iov;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; result : results) {</div>
<div class="line">    iov.push_back({result.data(), result.size()});</div>
<div class="line">    <span class="keywordflow">if</span> (iov.size() &gt;= 100) {</div>
<div class="line">        writev(fd, iov.data(), iov.size());</div>
<div class="line">        iov.clear();</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md52"></a>
4. Zero-Copy File Reading (mmap)</h2>
<p><b>Optimization:</b> Memory-map files for content search</p>
<p><b>Benefit:</b></p><ul>
<li>Kernel handles page caching</li>
<li>No user-space buffer copying</li>
<li>Efficient for large files</li>
</ul>
<p><b>Implementation:</b> </p><div class="fragment"><div class="line"><a class="code hl_struct" href="structMappedFile.html">MappedFile</a> mf(path);</div>
<div class="line"><span class="keywordflow">if</span> (mf.valid()) {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* data = mf.data();</div>
<div class="line">    <span class="keywordtype">size_t</span> size = mf.size();</div>
<div class="line">    <span class="comment">// Scan data directly without copying</span></div>
<div class="line">}</div>
<div class="ttc" id="astructMappedFile_html"><div class="ttname"><a href="structMappedFile.html">MappedFile</a></div><div class="ttdef"><b>Definition</b> ffind-daemon.cpp:1880</div></div>
</div><!-- fragment --><hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md54"></a>
5. Path Index for Directory Queries</h2>
<p><b>Optimization:</b> Precomputed map of directory → entries</p>
<p><b>Benefit:</b></p><ul>
<li>Fast <span class="tt">-path "dir/*"</span> queries</li>
<li>Avoids scanning all entries</li>
<li>O(1) lookup + O(k) iteration (k = files in dir)</li>
</ul>
<p><b>Rebuild Strategy:</b></p><ul>
<li>Rebuilt when entries modified</li>
<li>Cached until next modification</li>
<li>Lazy evaluation</li>
</ul>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md56"></a>
6. inotify for Real-Time Updates</h2>
<p><b>Optimization:</b> Use Linux inotify instead of periodic rescans</p>
<p><b>Benefit:</b></p><ul>
<li>Zero polling overhead</li>
<li>Instant index updates</li>
<li>No missed changes</li>
</ul>
<p><b>Watch Descriptor Management:</b></p><ul>
<li>Recursive watches on all directories</li>
<li>Automatic cleanup on directory deletion</li>
<li>Cookie-based rename tracking</li>
</ul>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md58"></a>
7. SQLite Write-Ahead Logging (WAL)</h2>
<p><b>Optimization:</b> Enable WAL mode for database</p>
<p><b>Benefit:</b></p><ul>
<li>Concurrent readers during writes</li>
<li>Atomic commits</li>
<li>Better crash recovery</li>
</ul>
<p><b>Configuration:</b> </p><div class="fragment"><div class="line">PRAGMA journal_mode=WAL;</div>
<div class="line">PRAGMA synchronous=NORMAL;  <span class="comment">-- Balance safety/performance</span></div>
</div><!-- fragment --><hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md60"></a>
Performance Benchmarks Summary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Operation  </th><th class="markdownTableHeadNone">Time  </th><th class="markdownTableHeadNone">Notes  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Index 10,000 files  </td><td class="markdownTableBodyNone">~2 seconds  </td><td class="markdownTableBodyNone">One-time startup cost  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Name pattern search  </td><td class="markdownTableBodyNone">&lt;1ms  </td><td class="markdownTableBodyNone">In-memory scan with filtering  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Content search (grep-like)  </td><td class="markdownTableBodyNone">20-50ms  </td><td class="markdownTableBodyNone">Parallel, all cores, 5,000 files  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Directory path search  </td><td class="markdownTableBodyNone">&lt;1ms  </td><td class="markdownTableBodyNone">Path index lookup  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">inotify update latency  </td><td class="markdownTableBodyNone">&lt;1ms  </td><td class="markdownTableBodyNone">From fs event to index update  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Database flush (10k rows)  </td><td class="markdownTableBodyNone">~100ms  </td><td class="markdownTableBodyNone">Every 30s or 100 changes  </td></tr>
</table>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md62"></a>
Appendix: Build and Development</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md63"></a>
Build Process</h2>
<div class="fragment"><div class="line"># Install dependencies</div>
<div class="line">sudo apt-get install build-essential libsqlite3-dev libre2-dev</div>
<div class="line"> </div>
<div class="line"># Build</div>
<div class="line">make clean &amp;&amp; make</div>
<div class="line"> </div>
<div class="line"># Outputs:</div>
<div class="line">#   ffind-daemon (daemon binary)</div>
<div class="line">#   ffind (client binary)</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md64"></a>
Development Guidelines</h2>
<ol type="1">
<li><b>Code Style:</b><ul>
<li>Modern C++20 features preferred</li>
<li>Use RAII for all resources</li>
<li>Prefer <span class="tt">std::</span> containers over raw arrays</li>
</ul>
</li>
<li><b>Error Handling:</b><ul>
<li>Check ALL system call return values</li>
<li>Use exceptions sparingly (prefer error codes)</li>
<li>Document error conditions in function headers</li>
</ul>
</li>
<li><b>Testing:</b><ul>
<li>Run <span class="tt">./tests/run_tests.sh</span> after changes</li>
<li>Test with large directories (100k+ files)</li>
<li>Verify zero compiler warnings</li>
</ul>
</li>
<li><b>Security:</b><ul>
<li>Add <span class="tt">// SECURITY:</span> comments for security-critical code</li>
<li>Use <span class="tt">// REVIEWER_NOTE:</span> for complex logic needing review</li>
<li>Run static analyzers (cppcheck, clang-tidy)</li>
</ul>
</li>
</ol>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md66"></a>
Glossary</h1>
<ul>
<li><b><a class="el" href="structEntry.html">Entry</a></b> - A single file or directory in the index</li>
<li><b>inotify</b> - Linux kernel subsystem for filesystem event monitoring</li>
<li><b>Watch Descriptor (WD)</b> - Kernel handle for monitored directory</li>
<li><b>Path Index</b> - Auxiliary data structure mapping directories to entries</li>
<li><b>Content Search</b> - Grep-like scanning of file contents</li>
<li><b>WAL</b> - Write-Ahead Logging (SQLite journaling mode)</li>
<li><b>Reconciliation</b> - Process of syncing database with actual filesystem</li>
<li><b>Context Lines</b> - Lines before/after a match (like grep -A/-B/-C)</li>
</ul>
<hr  />
<p><b>End of Architecture Documentation</b></p>
<p>For implementation details, see source code comments. <br  />
 For usage information, see README.md. <br  />
 For security audit notes, see function-level documentation in source files. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
